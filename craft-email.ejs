<%- contentFor('css') %>
  <link rel="stylesheet" type="text/css" href="/assets/css/vendors/slick.css" />
  <link rel="stylesheet" type="text/css" href="/assets/css/vendors/slick-theme.css" />
  <link rel="stylesheet" type="text/css" href="/assets/css/vendors/scrollbar.css" />
  <link rel="stylesheet" type="text/css" href="/assets/css/vendors/animate.css" />

  <style>
    a[class="btn-primary btn btn-light"] {
      background-color: rgba(115, 102, 255, 0.1) !important;
    }
  </style>

  <%- contentFor('body') %>
    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-12">
          <div class="card">
            <div class="card-header">
              <h5>Craft A Email With AI Using Your Product URL</h5>
              <span>Follow the steps to add your product & generate an email</span>
            </div>
            <div class="card-body">
              <div class="stepwizard">
                <div class="stepwizard-row setup-panel">
                  <div class="stepwizard-step">
                    <a class="btn btn-primary" href="#step-1">1</a>
                    <p>Products</p>
                  </div>
                  <div class="stepwizard-step">
                    <a class="btn btn-light" href="#step-2">2</a>
                    <p>Choose Template & Logo</p>
                  </div>
                  <div class="stepwizard-step">
                    <a class="btn btn-light" href="#step-3">3</a>
                    <p>Review Input</p>
                  </div>
                </div>
              </div>
              <form action="#" id="formSubmit" enctype="multipart/form-data">

                <!-- Step 1: Product URL -->
                <div class="setup-content" id="step-1">
                  <div class="col-xs-12">
                    <div class="col-md-12">
                      <div class="mb-3">
                        <label class="form-label" for="productUrl">Product URL:<span
                            class="font-danger">*</span></label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="icofont icofont-link"></i></span>
                          <input class="form-control" id="productUrl" name="productUrl" type="text"
                            placeholder="Enter product URL" />
                        </div>
                      </div>

                      <!-- Add Related Products -->
                      <div class="mb-3">
                        <label class="form-label" for="relatedProducts">Add Related Products (optional):</label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="icofont icofont-link"></i></span>
                          <textarea class="form-control" id="relatedProducts" name="relatedProducts" rows="3"
                            placeholder="Enter up to three related product URLs separated by lines"></textarea>
                        </div>
                      </div>

                      <button class="btn btn-primary nextBtn pull-right" type="button">Next</button>
                    </div>
                  </div>
                </div>

                <!-- Step 2: Choose Template -->
                <div class="setup-content" id="step-2">
                    <div class="row">
                      <div class="col-sm-6">
                        <div class="card">
                          <div class="media p-20">
                            <div class="form-check radio radio-primary me-3">
                              <input class="form-check-input" id="radio14" type="radio" name="templateChoice"
                                value="Template1" />
                              <label class="form-check-label" for="radio14"></label>
                            </div>
                            <div class="media-body">
                              <h6 class="mt-0 mega-title-badge">Email Template 1<span
                                  class="badge badge-primary pull-right digits">Option 1</span></h6>

                              <div class="col-xl-3 col-sm-6 xl-4">
                                <div class="card">
                                  <div class="product-box">
                                    <div class="product-img" style="cursor: pointer;"
                                      onclick="document.getElementById('radio14').click()">
                                      <div class="ribbon ribbon-danger">New</div>
                                      <img class="img-fluid" src="/assets/images/template-1.png" alt="" />
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-sm-6">
                        <div class="card">
                          <div class="media p-20">
                            <div class="form-check radio radio-secondary me-3">
                              <input class="form-check-input" id="radio13" type="radio" name="templateChoice"
                                value="Template2" />
                              <label class="form-check-label" for="radio13"></label>
                            </div>
                            <div class="media-body">
                              <h6 class="mt-0 mega-title-badge">Email Template 2<span
                                  class="badge badge-primary pull-right digits">Option 2</span></h6>

                              <div class="col-xl-3 col-sm-6 xl-4">
                                <div class="card">
                                  <div class="product-box">
                                    <div class="product-img" style="cursor: pointer;"
                                      onclick="document.getElementById('radio13').click()">
                                      <div class="ribbon ribbon-danger">New</div>
                                      <img class="img-fluid" src="/assets/images/template-2.png" alt="" />
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-sm-12 mb-3">
                        <div class="form-group">
                          <label for="logoInput">Add Company Logo. This will appear in your email (Optional):</label>
                          <input type="file" class="form-control" id="logoInput" name="logoUrl" accept="image/*" />
                        </div>
                      </div>
                    </div>
                    <button class="btn btn-primary nextBtn pull-right" type="button">Next</button>
                </div>

                <!-- Step 3: Review Input -->
                <div class="setup-content" id="step-3">
                  <div class="col-xs-12">
                    <div class="col-md-12">
                      <!-- JS will be used here to display the choices from previous steps -->
                      <div id="review-section">
                        <!-- JS Populated Data -->
                      </div>
                      <div id="error-message" style="color: red;"></div>

                      <button class="btn btn-success pull-right" type="submit">Generate AI Email!</button>
                    </div>
                  </div>
                </div>

              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%- contentFor('script') %>
      <script src="/assets/js/sidebar-menu.js"></script>
      <script src="/assets/js/slick/slick.min.js"></script>
      <script src="/assets/js/slick/slick.js"></script>
      <script src="/assets/js/header-slick.js"></script>
      <script src="/assets/js/form-wizard/form-wizard-two.js"></script>

      <script>
        document.querySelector('#formSubmit').addEventListener('submit', async function (event) {
          event.preventDefault();
          try {
            const formData = new FormData(this);
            const response = await fetch('/api/submit-form', {
              method: 'POST',
              body: formData
            });
            const data = await response.json();
            console.log(data);
            window.location.href = '/view-all-emails?requestSent=true';
          } catch (error) {
            console.error('Error:', error);
            document.getElementById('error-message').textContent = 'An error occurred while submitting the form. Please try again.';
          }
        });


        // When the user clicks the 'Next' button
        document.querySelectorAll(".nextBtn").forEach(function (btn) {
          btn.addEventListener("click", function () {
            if (document.querySelector("#step-2").contains(btn)) {
              reviewInputs(); // Trigger the review only after the template selection step
            }
          });
        });

        function reviewInputs() {
          // Get values
          console.log("Review Inputs Triggered"); // Add this line
          const productUrl = document.querySelector("#productUrl").value;
          const relatedProducts = document.querySelector("#relatedProducts").value;
          const logoInput = document.querySelector("#logoInput").files[0];
          let logoFileName = logoInput ? logoInput.name : "No logo uploaded";

          const selectedTemplate = document.querySelector('input[name="templateChoice"]:checked');
          let templateText = "";

          if (selectedTemplate && selectedTemplate.value === "Template1") {
            templateText = "Template 1";
          } else if (selectedTemplate && selectedTemplate.value === "Template2") {
            templateText = "Template 2";
          }

          // Populate the review section
          const reviewSection = document.querySelector("#review-section");
          reviewSection.innerHTML = `
      <h5>Review Your Input</h5>
      <p><strong>Product URL:</strong> ${productUrl}</p>
      <p><strong>Related Products:</strong> ${relatedProducts || "None"}</p>
      <p><strong>Selected Template:</strong> ${templateText}</p>
      <p><strong>Logo:</strong> ${logoFileName}</p>
    `;
        }
      </script>